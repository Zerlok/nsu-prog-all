#!/bin/bash

ccpp="g++"
cppflags="-std=c++11"
libs=()

pro="${1##*/}"
pro="${pro%%.pro}"

dir="${1%%/*}"

#
# Compile task itself with main.cpp
#
sources=()
while read line
do
    if [[ $line == "SOURCES += "* ]]
    then
        linesources=(${line##*+= })
	for source in ${linesources[@]}
	do
		sources+=("$dir/$source")
	done
    fi

    if [[ $line == "LIBS += "* ]]
    then
        libs+=(${line##*+= })
    fi
done < "$1"

echo "${ccpp} ${cppflags} ${sources[@]} -o main-${pro} ${libs[@]}"
${ccpp} ${cppflags} ${sources[@]} -o main-${pro} ${libs[@]}


#
# Compile task with google test
#
gtestsources=("${dir}/gtest.cpp")
for src in ${sources[@]}
do
	if [[ "$src" != *"main.cpp" ]]
	then
		gtestsources+=("$src")
	fi
done

echo "${ccpp} ${cppflags} ${gtestsources[@]} -o gtest-${pro} ${libs[@]} -lgtest -lpthread"
${ccpp} ${cppflags} ${gtestsources[@]} -o gtest-${pro} ${libs[@]} -lgtest -lpthread
