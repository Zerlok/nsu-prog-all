#!/bin/bash

#
# Main constants.
#
CCPP="g++"
CCPP_FLAGS="-std=c++11"
CCPP_LIBS=()
VERBOSE=false
DO_COMPILATION=true


#
# Input options.
#
GTEST_ENABLED=true
MAIN_ENABLED=true
USE_OBJECTS=false
TARGET_DIR="."
TARGET_NAME=
SOURCES_DIR=
OBJECTS_DIR=
PRO_PATH=
TASK=


#
# Show help message.
#
function help_message()
{
	echo "Usage: ${0} FILE [OPTIONS...]"
	echo "   FILE - is a QT *.pro file"
	echo
	echo "Available options:"
	echo "   -g, --gtest-only           - compile google test only"
	echo "   -m, --main-only            - compile main only"
	echo "   -t, --traget [DIR]         - target dir (for shadow compilation)"
	echo "   -n, --name [NAME]          - name of compiled program (use when gtest or main compilation specified)"
	echo "   -G, --gtest-objects [DIR]  - compile google test only by using *.o project compiled files from specified dir"
	echo "   --no-compile               - avoid ${CCPP} compilation"
	echo "   -v, --verbose              - show debug messages"
}


#
# Show parsed input arguments.
#
function show_parsed_input()
{
	echo "Parsed input:"
	echo "   Task:          $TASK"
	echo "   Pro file:      $PRO_PATH"
	echo "   Gtest enabled: $GTEST_ENABLED"
	echo "   Using objects: $USE_OBJECTS"
	echo "   Main enabled:  $MAIN_ENABLED"
	echo "   Target name:   $TARGET_NAME"
	echo "   Target dir:    $TARGET_DIR"
	echo "   Objects dir:   $OBJECTS_DIR"
	echo "   Sources dir:   $SOURCES_DIR"
}


#
# Parse bash-script input arguments.
#
function parse_input_arguments()
{
	while [[ $# -gt 0 ]]
	do
		case "$1" in
			-h|--help)
				help_message
				exit 0
				;;
			-g|--gtest-only)
				GTEST_ENABLED=true
				MAIN_ENABLED=false
				;;
			-m|--main-only)
				GTEST_ENABLED=false
				MAIN_ENABLED=true
				;;
			-t|--target)
				TARGET_DIR="${2%%/}"
				shift
				;;
			-n|--name)
				TARGET_NAME="$2"
				shift
				;;
			-G|--gtest-objects)
				GTEST_ENABLED=true
				USE_OBJECTS=true
				MAIN_ENABLED=false
				OBJECTS_DIR="${2%%/}"
				shift
				;;
			-v|--verbose)
				VERBOSE=true
				;;
			--no-compile)
				DO_COMPILATION=false
				;;
			*)
				if [[ -z $PRO_PATH ]]
				then
					PRO_PATH="$1"
				else
					echo "Unknown argument: $1, use --help"
					exit 1
				fi
				;;
		esac
		shift
	done

	if [[ -z $PRO_PATH ]]
	then
		echo "A .pro file is not specified!"
		exit 1
	elif [ ! -f $PRO_PATH ]
	then
		echo "${PRO_PATH} does not exists or is not a file!"
		exit 1
	elif [[ "${PRO_PATH}" != *".pro" ]]
	then
		echo "${PRO_PATH} is not a .pro file!"
		exit 1
	fi

	SOURCES_DIR=$(dirname ${PRO_PATH})
	pro_file="${PRO_PATH##*/}"
	TASK="${pro_file%%.pro}"
}


#
# Parse *.pro file.
#
function parse_pro_file()
{
	while read line
	do
		if [[ $line == "SOURCES += "* ]]
		then
		    linesources=(${line##*+= })
			for src in ${linesources[@]}
			do
				sources+=("$SOURCES_DIR/$src")
			done
		fi

		if [[ $line == "LIBS += "* ]]
		then
		    CCPP_LIBS+=(${line##*+= })
		fi
	done < "$1"
}


#
# Get sources for Google Unit test.
#
function get_gtest_sources()
{
	gsources=("${SOURCES_DIR}/gtest.cpp")
	for src in $@
	do
		if [[ "$src" != *"main."* ]]
		then
			gsources+=("$src")
		fi
	done
}


#
# Compile main task (main.cpp)
#
function compile_main()
{
	name="${TARGET_NAME}"
	if [[ -z $name ]]
	then
		name="main-${TASK}"
	fi

	echo "${CCPP} ${CCPP_FLAGS} ${sources[@]} -o ${TARGET_DIR}/${name} ${CCPP_LIBS[@]}"

	if $DO_COMPILATION
	then
		${CCPP} ${CCPP_FLAGS} ${sources[@]} -o ${TARGET_DIR}/${name} ${CCPP_LIBS[@]}
	fi
}


#
# Compile task with google test
#
function compile_gtest()
{
	if $USE_OBJECTS
	then
		objects=("${OBJECTS_DIR}/*.o")
		get_gtest_sources "${objects[@]}"
	else
		get_gtest_sources "${sources[@]}"
	fi

	name="${TARGET_NAME}"
	if [[ -z $name ]]
	then
		name="gtest-${TASK}"
	elif $MAIN_ENABLED
	then
		name="gtest-${name}"
	fi

	echo "${CCPP} ${CCPP_FLAGS} ${gsources[@]} -o ${TARGET_DIR}/${name} ${CCPP_LIBS[@]} -lgtest -lpthread"

	if $DO_COMPILATION
	then
		${CCPP} ${CCPP_FLAGS} ${gsources[@]} -o ${TARGET_DIR}/${name} ${CCPP_LIBS[@]} -lgtest -lpthread
	fi
}


function main()
{
	sources=()
	gsources=()

	parse_pro_file $PRO_PATH

	if $GTEST_ENABLED
	then
		compile_gtest
	fi

	if $MAIN_ENABLED
	then
		compile_main
	fi
}


parse_input_arguments $@

if $VERBOSE
then
	show_parsed_input
fi

main $@
